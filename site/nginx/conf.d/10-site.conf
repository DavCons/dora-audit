# Wczytywane wewnątrz bloku http {} z domyślnego nginx.conf obrazu

# rate-limit (10 req/s / IP)
limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;

# DNS dla proxy_pass na *.supabase.co
resolver 1.1.1.1 1.0.0.1 ipv6=off;

# logi – krótki format (opcjonalnie)
log_format short '$remote_addr - $remote_user [$time_local] '
                 '"$request" $status $body_bytes_sent '
                 '"$http_referer" "$http_user_agent"';
access_log /var/log/nginx/access.log short;

server {
  listen 80 default_server;
  server_name _;

  # 444 dla metod innych niż GET/HEAD/POST/OPTIONS
  if ($request_method !~ ^(GET|HEAD|POST|OPTIONS)$) { return 444; }

  # Sekret Bearer (include montowany z hosta)
  include /etc/nginx/includes/checkout_token.conf;

  # ====== PUBLIC API: /api/request-magic-link ======
  location = /api/request-magic-link {
      # CORS preflight
      if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin "$http_origin" always;
        add_header Vary "Origin" always;
        add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;
        add_header Access-Control-Allow-Credentials "true" always;
        return 204;
      }
      # tylko POST (poza preflightem)
      if ($request_method != POST) { return 405; }

      # rate-limit
      limit_req zone=req_limit burst=20 nodelay;

      # CORS dla POST
      add_header Access-Control-Allow-Origin "$http_origin" always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Credentials "true" always;

      # proxy do Supabase Edge Function
      proxy_pass https://jizmjayxnidelnnumcja.supabase.co/functions/v1/request-magic-link;
      proxy_ssl_server_name on;
      proxy_http_version 1.1;
      proxy_set_header Connection "";

      # tajny Bearer z include
      proxy_set_header Authorization $EDGE_FUNCTION_TOKEN;
      proxy_set_header Content-Type "application/json";

      # forwarding info
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      client_max_body_size 2k;
    }

  # ====== /api/request-magic-link ======

  # Nagłówki bezpieczeństwa (CSP dopasowane do CDN-ów i Supabase)
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options DENY always;
  add_header Referrer-Policy no-referrer-when-downgrade always;
  add_header Content-Security-Policy "
    default-src 'self';
    script-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
    style-src   'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://unpkg.com;
    font-src    'self' https://fonts.gstatic.com data:;
    img-src     'self' data:;
    connect-src 'self' https://*.supabase.co;
    object-src  'none';
    base-uri    'self';
    frame-ancestors 'none';
  " always;

  # rate-limit globalny
  limit_req zone=req_limit burst=20 nodelay;

  # statyki
  root /usr/share/nginx/html;
  index index.html index_pl.html index_en.html;

  location ~* \.(?:css|js|mjs|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
    expires 7d;
    add_header Cache-Control "public, max-age=604800, immutable";
    try_files $uri =404;
  }

  location = /robots.txt  { try_files $uri =404; }
  location = /favicon.ico { try_files $uri =404; }

  location / {
    try_files $uri $uri/ =404;
  }
}
