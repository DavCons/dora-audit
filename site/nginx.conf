# Minimal, hardened Nginx for static site
# - ciche ucinanie nietypowych metod (444)
# - rate limiting
# - bezpieczne nagłówki
# - proste logowanie

worker_processes auto;

events {
    worker_connections 1024;
}

http {
  # -------- Global --------
  server_tokens off;

  # Log format (krótki)
  log_format short '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent"';

  access_log /var/log/nginx/access.log short;
  error_log  /var/log/nginx/error.log warn;

  # Gzip dla statyk
  gzip on;
  gzip_types text/plain text/css application/javascript application/json image/svg+xml;
  gzip_min_length 1024;

  # Rate limit (10 req/s / IP, burst 20)
  limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;

  # -------- Optional: HTTP -> HTTPS redirect --------
  # Odkomentuj, jeśli ten kontener stoi również na 443 (albo za reverse proxy TLS)
  # server {
  #     listen 80 default_server;
  #     server_name _;
  #     return 301 https://$host$request_uri;
  # }

  # -------- Main server --------
  server {
    listen 80 default_server;
    server_name _;

    # Ciche odrzucenie metod innych niż GET/HEAD/POST
    if ($request_method !~ ^(GET|HEAD|POST)$) {
        return 444;
    }

    # Bezpieczne nagłówki
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header Referrer-Policy no-referrer-when-downgrade always;
    # Dostosuj CSP do własnych potrzeb; dla czystych statyk powinno wystarczyć:
    add_header Content-Security-Policy "
      default-src 'self';
      script-src  'self' https://cdn.jsdelivr.net https://unpkg.com;
      style-src   'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://unpkg.com;
      font-src    'self' https://fonts.gstatic.com data:;
      img-src     'self' data:;
      connect-src 'self' https://*.supabase.co;
      object-src  'none';
      base-uri    'self';
      frame-ancestors 'none';
    " always;

    # Rate limit – stosujemy na całe / (możesz przenieść per-location)
    limit_req zone=req_limit burst=20 nodelay;

    # Statyczne pliki
    root /usr/share/nginx/html;
    index index_pl.html index_en.html index.html;

    # robots.txt i favicon
    location = /robots.txt { try_files $uri =404; }
    location = /favicon.ico { try_files $uri =404; }

    # Serwowanie wszystkiego z katalogu; brak SPA – zwracaj 404
    location / {
      try_files $uri $uri/ =404;
    }
  }
}
