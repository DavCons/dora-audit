# Strona startowa — automatyczny wybór wersji językowej
  location = / {
    if ($lang_pref = pl) { return 302 /index.html; }
    if ($lang_pref = en) { return 302 /index_en.html; }
    return 302 /index.html;
  }

  # Pliki statyczne z cachingiem
  location ~* \.(?:css|js|mjs|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
    expires 7d;
    add_header Cache-Control "public, max-age=604800, immutable";
    try_files $uri =404;
  }

  # Domyślne serwowanie
  location / {
    # cichy DROP dla metod innych niż GET/HEAD
    if ($request_method !~ ^(GET|HEAD)$) { return 444; }
    try_files $uri $uri/ =404;
  }

  # ===== API: checkout-magic-link (dopisuje do whitelisty i wysyła mail) =====
  include /etc/nginx/includes/edge_function_token.conf;

  location = /api/checkout-magic-link {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin "$http_origin" always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type" always;
      add_header Access-Control-Allow-Credentials "true" always;
      return 204;
    }
    if ($request_method != POST) { return 405; }

    limit_req zone=req_limit burst=20 nodelay;
    add_header Access-Control-Allow-Origin "$http_origin" always;
    add_header Vary "Origin" always;
    add_header Access-Control-Allow-Credentials "true" always;

    # ➜ Supabase edge function (z SignInWithOtp)
    proxy_pass https://jizmjayxnidelnnumcja.supabase.co/functions/v1/checkout-magic-link;
    proxy_ssl_server_name on;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host jizmjayxnidelnnumcja.supabase.co;
    proxy_set_header Authorization "Bearer $EDGE_FUNCTION_TOKEN";
    proxy_set_header Content-Type "application/json";
  }

  # ===== API: login-magic-link (sprawdza whitelistę i wysyła mail) =====
  location = /api/login-magic-link {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin "$http_origin" always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type" always;
      add_header Access-Control-Allow-Credentials "true" always;
      return 204;
    }
    if ($request_method != POST) { return 405; }

    limit_req zone=req_limit burst=20 nodelay;
    add_header Access-Control-Allow-Origin "$http_origin" always;
    add_header Vary "Origin" always;
    add_header Access-Control-Allow-Credentials "true" always;

    # ➜ Supabase edge function (z SignInWithOtp)
    proxy_pass https://jizmjayxnidelnnumcja.supabase.co/functions/v1/login-magic-link;
    proxy_ssl_server_name on;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host jizmjayxnidelnnumcja.supabase.co;
    proxy_set_header Authorization "Bearer $EDGE_FUNCTION_TOKEN";
    proxy_set_header Content-Type "application/json";
  }
}
